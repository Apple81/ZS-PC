<!DOCTYPE html>
<html lang="en">

    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta charset="utf-8" />
        <title>表单归集 - 中山建设监理建筑工程文档协同管理系统</title>

        <meta name="description" content="overview &amp; stats" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
        <!--tree-->
        <link rel="stylesheet" href="<?php echo base_url()."assets/tree_LigerUI/css/ligerui-tree.css"?>" type="text/css" />

        <!-- bootstrap & fontawesome -->
        <link rel="stylesheet" href="<?php echo base_url()."assets/css/bootstrap.min.css"?>" />
        <link rel="stylesheet" href="<?php echo base_url()."assets/font-awesome/4.5.0/css/font-awesome.min.css"?>" />

        <!-- page specific plugin styles -->
        <link rel="stylesheet" href="<?php echo base_url()."assets/css/bootstrap-duallistbox.min.css"?>" />
        <link rel="stylesheet" href="<?php echo base_url()."assets/css/bootstrap-multiselect.min.css"?>" />
        <link rel="stylesheet" href="<?php echo base_url()."assets/css/select2.min.css"?>" />
        <link rel="stylesheet" href="<?php echo base_url()."assets/css/jquery-ui.min.css"?>" />
        <link rel="stylesheet" href="<?php echo base_url()."assets/css/colorbox.min.css"?>" />

        <!-- text fonts -->
        <link rel="stylesheet" href="<?php echo base_url()."assets/css/fonts.googleapis.com.css"?>" />

        <!-- ace styles -->
        <link rel="stylesheet" href="<?php echo base_url()."assets/css/ace.min.css"?>" class="ace-main-stylesheet" id="main-ace-style" />
        
        <!--self css-->
        <link rel="stylesheet" href="<?php echo base_url()."assets/css/self/self.css"?>" />
        
        <!--[if lte IE 9]>
            <link rel="stylesheet" href="<?php echo base_url()."assets/css/ace-part2.min.css"?>" class="ace-main-stylesheet" />
        <![endif]-->
        <link rel="stylesheet" href="<?php echo base_url()."assets/css/ace-skins.min.css"?>" />
        <link rel="stylesheet" href="<?php echo base_url()."assets/css/ace-rtl.min.css"?>" />

        <!--[if lte IE 9]>
          <link rel="stylesheet" href="<?php echo base_url()."assets/css/ace-ie.min.css"?>" />
        <![endif]-->

        <!-- inline styles related to this page -->

        <!-- ace settings handler -->
        <script src="<?php echo base_url()."assets/js/ace-extra.min.js"?>"</script>></script>

        <!-- HTML5shiv and Respond.js for IE8 to support HTML5 elements and media queries -->

        <!--[if lte IE 8]>
        <script src="<?php echo base_url()."assets/js/html5shiv.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/respond.min.js"?>"></script>
        <![endif]-->
        <style type="text/css">
            .spanBackground {
                background: #7db4d8;
            }
        </style>
    </head>

    <body class="no-skin">
        <!--Top Begin-->
        <?php $this->load->view("pageTop.html"); ?>
        <!--Top End-->

        <div class="main-container ace-save-state" id="main-container">
            <!--LeftTree Begin-->
            <?php $this->load->view("pageLeft.html"); ?>
            <!--LeftTree End-->

            <div class="main-content">
                <div class="widget-body">
                    <div class="widget-main padding-24">
                        <!--Action Button Beg-->
                        <div class="col-lg-5">
                            <button class="btn btn-primary NoSelTabType" id="OpenShut">展开</button>
                            <!-- <input class="input-elm" id="CheckTreeDom"/> -->
                            <!-- <button class="btn btn-primary" id="CheckTreeDomAct">查找</button> -->
                        </div>
                        <div class="col-lg-7">
                            <input id="formId" hidden="hidden"/>
                            <!--<button class="btn btn-primary" id="CallBk" onclick="ChangeSta(StaChange+'/CallBk/pack','pack')">撤回归集</button>-->
                            <button class="btn btn-primary" id="printOut" href="#" >浏览</button>
                            <button class="btn btn-primary" id="wgbutton" href="#modal-wgcompare" role="button" data-toggle="modal">工作组比对</button>
                        </div>
                        <!--Action Button End-->
                        <!--form tree begin-->
                        <?php $this->load->view('model_tree.html'); ?>
                        <!--form tree end-->
                        <!--form list begin-->
                        <?php // $this->load->view("form_list.html"); ?>
                        <!--form list end-->
                        <!--form mess begin-->
                        <?php $this->load->view("form_attr.html"); ?>
                        <!--form mess end-->
                        <!--model part begin-->
                        <?php $this->load->view('model_workg.html'); ?>
                        <?php $this->load->view('model_page.html'); ?>
                        <!--model part begin-->
                    </div>
                </div>
            </div>
            <!-- /.main-content -->
            
            <!--Foor Begin-->
            <?php $this->load->view("pageFoot.html"); ?>
            <!--Foot End-->
            
        </div>
        <!-- /.main-container -->

        <!-- basic scripts -->

        <!--[if !IE]> -->
        <script src="<?php echo base_url()."assets/js/jquery-2.1.4.min.js"?>"></script>

        <!-- <![endif]-->

        <!--[if IE]>
        <script src="<?php echo base_url()."assets/js/jquery-1.11.3.min.js"?>"></script>
        <![endif]-->
        <script src="<?php echo base_url()."assets/js/bootstrap.min.js"?>"></script>

        <!-- page specific plugin scripts -->
        <script src="<?php echo base_url()."assets/js/jquery.bootstrap-duallistbox.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/jquery.raty.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/bootstrap-multiselect.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/select2.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/jquery-typeahead.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/jquery-ui.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/jquery.ui.touch-punch.min.js"?>"></script>
        
        <!--tree-->
        <script src="<?php echo base_url()."assets/tree_LigerUI/js/base.js"?>"></script>
        <script src="<?php echo base_url()."assets/tree_LigerUI/js/ligerTreeShow.js"?>"></script>
        
        <!--dataTable-->
        <script src="<?php echo base_url()."assets/js/jquery.dataTables.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/jquery.dataTables.bootstrap.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/dataTables.buttons.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/buttons.flash.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/buttons.html5.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/buttons.print.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/buttons.colVis.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/dataTables.select.min.js"?>"></script>
        
        <!-- ace scripts -->
        <script src="<?php echo base_url()."assets/js/ace-elements.min.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/ace.min.js"?>"></script>

        <!-- inline scripts related to this page -->
        <script src="<?php echo base_url()."assets/js/self/Show_LeftTreeA.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/self/ActionMes.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/self/api.js"?>"></script>
        <script src="<?php echo base_url()."assets/js/self/ActionForm.js"?>"></script>
        <!--<script src="<?php echo base_url()."assets/js/self/ActionWgcompare.js"?>"></script>-->
        <script type="text/javascript">
            var dataUri = sessionStorage.getItem('ModleId');
            projectId = sessionStorage.getItem('projectId')
            var TreeMes = []
            var MesArray = "" //树目录的数据
            var tabMesAll;
            var StaChange = "<?php echo site_url('MesContro/StaChange') ?>"
            var PackMes = "<?php echo site_url('MesContro/GetPackMes') ?>"+'/'+projectId;//获取当前工程归集表单
            AimUrl = "<?php echo site_url('MesContro/PrintOut'); ?>"
            jQuery(function($) {
                /*
                 * datatable INI
                 */
                
                /*
                 * tree INI
                 */
                var Tree = "<?php echo site_url('MesContro/GetTreeNodePack') ?>"+'/'+projectId;
//              console.log(Tree)
                $.ajax({
                    type:"post",
                    url:Tree,
                    async:true,
                    success:function(data)
                    {
//                  	console.log(data)
                        MesArray = eval("("+data+")")
                        TreeMes = $(".l-tree").ligerTree({
                            data:MesArray,
                            idFieldName :'nodeId',
                            checkbox:false,
                            slide : false,
                            parentIDFieldName :'parentId',
                            textFieldName :'nodeName',
                            onSelect: onSelect
                        });
                        treeManager = $(".l-tree").ligerGetTreeManager();
                        treeManager.collapseAll();
                        $('#OpenShut').removeClass('NoSelTabType')
                    },
                    error:function(s,t,e)
                    {
                        console.log(s,t,e);
                    }
                })
                /*
                 * tree Action
                 */
                $('#OpenShut').on('click',function(){
                    if($('#OpenShut').text() == '展开'){
                        TreeMes.expandAll()
                       $('#OpenShut').val('关闭')
                       $('#OpenShut').text('关闭')
                       return;
                    }
                    TreeMes.collapseAll()
                    $('#OpenShut').val('展开')
                    $('#OpenShut').text('展开')
                })
                $('#CheckTreeDomAct').on('click',function(){
                    console.log($('#CheckTreeDom').val())
                    TreeMes.getNodeDom ($('#CheckTreeDom').val())
                })
                function onSelect(note) {
                    if(!note.data.children){
                        $('#formId').attr('value',note.data.nodeId)
                        var MesShow = "<?php echo site_url('Form/FormgetBC') ?>"+'/'+note.data.nodeId;
    //                  console.log(MesShow)
                        $.ajax({
                            type:"post",
                            url:MesShow,
                            async:true,
                            dataType:'json',
                            success:function(data){
    //                          console.log(data)
                                showFormMes(data)
                            },
                            error:function(s,e,t){
                                alert('出现错误，请及时联系管理员[FD001]')
                            }
                        });
                    }
                }

                /*
                 * table Action
                 */
                $('#dynamic-table tbody').on('click', 'tr', function () {
                    if ($(this).hasClass('selected')) {
                        $(this).removeClass('selected');
                    }
                    else {
                        tabMesAll.$('tr.selected').removeClass('selected');
                        $(this).addClass('selected');
                    }
                    try{
                        var formId = tabMesAll.row('.selected').data().formId;
                        var FormMesCheck = "<?php echo site_url('Form/FormMesLoad') ?>"+'/'+formId+'/pack';
                        window.open(FormMesCheck)
                    }catch(e){
                        
                    }
                })
                /*
                 * 树查询
                 */
                $("#searchTreeText").on("keyup",function(){
                    searchTree(this.value)
                })
                function searchTree(searchString){
                    $("span[class='spanBackground']").removeClass("spanBackground")
                    if(searchString){
                        for(var ky in MesArray){//ky:1,2,3,4,5,6,7,8,9...
                            var data2 = MesArray[ky]
                            if(data2 && data2["nodeName"].indexOf(searchString)>=0){
                                TreeMes.expandAll()
                                var  treedataindex = data2["treedataindex"]
                                $("li[treedataindex='"+treedataindex+"']").children("div").children("span").addClass("spanBackground")
                            }
                        }
                    }
                }
                /*
                 * datepicker
                 */
                $( "#datepickerForm" ).datepicker({
                    dateFormat: "yy-mm-dd",
                    showOtherMonths: true,
                    selectOtherMonths: false,
//                  isRTL:true,
                    beforeShow: function() {
                        //change button colors
                        var datepicker = $(this).datepicker( "widget" );
                        setTimeout(function(){
                            var buttons = datepicker.find('.ui-datepicker-buttonpane')
                            .find('button');
                            buttons.eq(0).addClass('btn btn-xs');
                            buttons.eq(1).addClass('btn btn-xs btn-success');
                            buttons.wrapInner('<span class="bigger-110" />');
                        }, 0);
                    }
                });
            });
            /*
             * 工作组比对功能
             */
            //清楚旧的工作组比对信息
            $('#wgbutton').on('click',function(){
            	$("#wgcompare").attr('disabled',false);
            	$("#box").html('');
            })
            //工作组比对功能
            $('#wgcompare').on('click',function(){
            	var wgid=$('#SelFormType option:selected').attr("data-id");
            	var wgmes="<?php echo site_url('System/Getwgmes') ?>";
            	var wgfinish="<?php echo site_url('MesContro/WgFinish') ?>"+'/'+projectId;
	            $.ajax({
	            	type:"post",
	            	url:wgmes,
	            	async:true,
	            	dataType:'json',
	            	data:{wgid:wgid},
	            	success:function(data){
//	            		console.log(data) 
	            		$.ajax({
	            			type:"post",
	            			url:PackMes,
	            			async:true,
	            			dataType:'json',
	            			success:function(data2){
	            				console.log(data2)
	            				var Needpack='';
	            				var tableData="<table class='table table-striped table-bordered table-hover'>";
			            		tableData+="<thead><tr><th>工作组表单</th><th>归集表单</th><th>对比结果</th><th>表单数量</th></tr></thead>";
			            		tableData+="<tbody>";
			            		var wg=data.length;//工作组的长度
	            				var pack=data2.length;//归集表单长度
			            		if(data.length>=data2.length){
			            			var n=pack;
			            			for(n;n<wg;n++){
			            				var obj = {};
									    obj.TabMNa = "null";
									    obj.num='0';
									    data2.push(obj);
			            			}
			            		}	
			            		else{
			            		    var n=wg;
			            			for(n;n<pack;n++){
			            				var obj = {};
									    obj.id ="0";
									    obj.workgname="null";
									    obj.tablegname="null";
									    data.push(obj);
			            			}
			            		}
			            		for(var j=0;j<data2.length;j++){
		            				for(var i=0;i<data.length;i++){
		            					if(data[i]['tablename']==data2[j]['TabMNa']){
		            					tableData+="<tr><td>"+data[i]['tablename']+"</td><td>"+data2[j]['TabMNa']+"</td><td>√</td><td>"+data2[j]['num']+"</td></tr>"
		            					$.ajax({
		            						type:"post",
		            						url:wgfinish,
		            						async:true,
		            						data:{
		            							TabMId:data2[j]['TabMId']
		            						},
		            						dataType:'json',
		            						success:function(data){
//		            							console.log(data);
		            						},
		            						error:function(s,e,t){
		            							alert('比对失败')
		            							return;
		            						}
		            					});
		            					Needpack+=data2[j]['TabMId']+',';//需要归集表单的模板名id
		            					//如果与工作组的相同,数组已变，为继续比较，i和j都要-1
		            					data.splice(i,1)
		            					data2.splice(j,1);
		            					i=i-1;
		            					j=j-1;
		            					break;
		            				 	}
		            				}
							    }
			            		
	            				for(var i=0;i<data.length;i++){
	            					tableData+="<tr><td>"+data[i]['tablename']+"</td>";
	            					tableData+="<td>"+data2[i]['TabMNa']+"</td><td>×</td><td>"+data2[i]['num']+"</td></tr>";
	            				}
							    tableData+="</tbody></table>";
							    $("#box").append(tableData);
							    alert('比对完成')
							    $("#formright").load(location.href+" #formright");
							    //备用方案
//							    var strs= new Array(); //定义一数组 
//								strs=Needpack.split(",");
//							    console.log(strs);
							    $("#wgcompare").attr('disabled',true);
							    var Tree = "<?php echo site_url('MesContro/GetTreeNodePack') ?>"+'/'+projectId;
							    //树的刷新
							    $.ajax({
				                    type:"post",
				                    url:Tree,
				                    async:true,
				                    success:function(data)
				                    {
				                        MesArray = eval("("+data+")")
				                        var op = {
							                delay: []
							            };
							            TreeMes.set(op);
				                        TreeMes.set('data',MesArray)
				                    },
				                    error:function(s,t,e)
				                    {
				                        alert('出现错误，错误类型：'+e)
				                    }
					             })
	            			},
	            			error:function(s,e,t){
	            				alert('获取归集表单错误');
	            			}
	            		});
	            	},
	            	error:function(s,e,t){
	            		alert('出现错误，请联系管理人员');
	            	}
	            });
            })
            /*
             * 工作组比对结束
             */
           
        </script>
    </body>

</html>